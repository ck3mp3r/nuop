#!/usr/bin/env nu

# Script to automatically install CRDs from /crds directory
# Runs at container startup for Standard mode

print "üîç Checking for CRDs to install..."

let CRDS_PATH = ($env | get --optional CRDS_PATH | default "/crds")

# Check if CRDs directory exists
if not ($CRDS_PATH | path exists) {
  print "‚ÑπÔ∏è  No /crds directory found - skipping CRD installation"
  exit 0
}

# Find all YAML files in the CRDs directory
let crd_files = (glob $"($CRDS_PATH)/**/*.yaml")

if ($crd_files | is-empty) {
  print $"‚ÑπÔ∏è  No CRD files found in ($CRDS_PATH)"
  exit 0
}

print $"üì¶ Found ($crd_files | length) CRD file\(s\) to process"

# Function to check if a CRD exists
def crd-exists [crd_name: string] {
  let result = (kubectl get crd $crd_name -o name | complete)
  $result.exit_code == 0
}

# Function to install or update a CRD
def install-crd [file_path: string] {
  print $"üìÑ Processing: ($file_path)"

  # Read and parse the CRD file
  let crd_content = try {
    open $file_path
  } catch {
    print $"‚ùå Error: Could not read ($file_path)"
    return false
  }

  # Extract CRD name from the file
  let crd_name = try {
    $crd_content | get metadata.name
  } catch {
    print $"‚ùå Error: Invalid CRD format in ($file_path)"
    return false
  }

  # Check if CRD already exists
  if (crd-exists $crd_name) {
    print $"‚úÖ CRD ($crd_name) already exists - updating..."

    # Apply the CRD (idempotent - will update if different)
    let result = (kubectl apply -f $file_path | complete)

    if $result.exit_code == 0 {
      print $"‚úÖ CRD ($crd_name) updated successfully"
      return true
    } else {
      print $"‚ùå Error updating CRD ($crd_name): ($result.stderr)"
      return false
    }
  } else {
    print $"‚ûï Installing new CRD: ($crd_name)"

    # Create the CRD
    let result = (kubectl apply -f $file_path | complete)

    if $result.exit_code == 0 {
      print $"‚úÖ CRD ($crd_name) installed successfully"

      # Wait for CRD to be established (ready to use)
      print $"‚è≥ Waiting for CRD ($crd_name) to be established..."

      let wait_result = (kubectl wait --for condition=established --timeout=60s $"crd/($crd_name)" | complete)

      if $wait_result.exit_code == 0 {
        print $"‚úÖ CRD ($crd_name) is ready"
        return true
      } else {
        print $"‚ö†Ô∏è  Warning: CRD ($crd_name) may not be fully ready"
        return true # Don't fail - it might work anyway
      }
    } else {
      print $"‚ùå Error installing CRD ($crd_name): ($result.stderr)"
      return false
    }
  }
}

# Process each CRD file
mut success_count = 0
mut error_count = 0

for file in $crd_files {
  if (install-crd $file) {
    $success_count = $success_count + 1
  } else {
    $error_count = $error_count + 1
  }
}

print ""
print "üìä CRD Installation Summary:"
print $"   ‚úÖ Successful: ($success_count)"
print $"   ‚ùå Errors: ($error_count)"

if $error_count > 0 {
  print "‚ö†Ô∏è  Some CRDs failed to install - operator may not work correctly"
  exit 1
}

print "‚úÖ All CRDs installed successfully"
exit 0
